# Laboratorio 55-C: "MySQL replicado con StatefulSet"
 
# Este laboratorio aprenderemos a usar el objeto 'StatefulSet'.

# Vamos desplegar topología replicada de MongoDB, usando un contenedor Sidecar

# Requisitos:
#
#   1) Una máquina virtual con Ubuntu 20.04 LTS a la que poder hacer ssh.
#
#   2) Cluster Minikube iniciado.


# Como ya hemos aprendido en este curso, deseamos aportar la capacidad de autoescalado al
# ReplicaSet, pero en este caso usaremos otra técnica que hace uso de un 'Sidecar'.
#
# El 'Sidecar' monitorizará los pods y, si se levanta una nueva réplica de MongoDB, el Sidecar la
# añadirá al ReplicaSet. Así mismo, si realizamos retiramos pods, el Sidecar lo tendrá en cuenta.
#
# Otra cuestión a aprender es conseguir que nuestros despliegues en Kubernetes sean seguros, así que
# tendremos en cuenta las buenas prácticas a usar con MongoDB. Protegeremos las comunicaciones entre
# los nodos MongoDB por medio de una clave, crearemos un usuario y habilitaremos la autenticación.



###################################################
# Ejercicio 1: Crear secretos y ejecutar scripts. #
###################################################

# La documentación de MongoDB nos dice que la imagen tiene la posibilidad de configurar scripts
# y ejecutarlos la primera vez que se inicia el contenedor. Utilizaremos esta técnica para configurar
# un usuarios (y passwords)

# Cambiamos al directorio de trabajo:

cd ~/k8s_desarrolladores/55

# Una técnica muy interesante el crear un script y almacenarlo en un CONFIGMAP. El script leerá
# información confidencial que se almacena en un secreto.

# Estudiemos el archivo del secreto.

code lab-55-C-mongo-secret.yaml


# Las líneas más destacables son:
#
# Línea 2:      Indica que estamos creando un secreto.
#
# Línea 5:      Con nombre 'mongo-secret'.
#
# Líneas 7 y 8: Codificación en Base64 para el nombre de usuario 'root' y un password robusto.

# Salimos sin modificar nada y aplicamos:

kubectl apply -f lab-55-C-mongo-secret.yaml


# A continuación declaramos un 'ConfigMap' que almacenará el script. Este script leerá el nombre de 
# del usuario administrador y su password desde variables de entorno cargadas a su vez desde el secreto.

# Echamos un vistazo al siguiente archivo:

code lab-55-C-mongo-configmap.yaml


# Las líneas más importantes son:
#
# Línea 2:      Es un 'ConfigMap'
#
# Línea 4:      Su nombre es 'mongo-init-script'.
#
# Línea 6:      El script se llama 'mongo-user-sh'.
#
# Líneas 7-12:  El script crea un usuario administrador cuyo nombre y password se toma respectivamente de las 
#               variables de entorno 'MONGO_INITDB_ROOT_USERNAME' y 'MONGO:_INITDB_ROOT_PASSWORD' que serán
#               inicializadas desde el secreto.
#
#               Posteriormente crea (si no existe) una base de datos con nombre 'mi_database'. Luego da de
#               alta un usuario llamado 'mi_database-user' con el password definido en la variable de entorno
#               'SECOND_USER_DB_PASSWORD'. A este usuario se le da el permiso RW en la base de datoa que se acaba
#               de crear.

# Cerramos sin modificar nada y aplicamos el ConfigMap:

kubectl apply -f lab-55-C-mongo-configmap.yaml





#######################
# FIN DEL LABORATORIO #
#######################
